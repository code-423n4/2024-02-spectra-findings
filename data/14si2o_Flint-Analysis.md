# Analysis of Spectra

![Spectra](https://github.com/Kraelog/images/blob/bdc78556b0846c7eaa0eb17ed92fa7e5b6ad718b/Spectra.jpg)

## 1. Description Spectra

Spectra is a permissionless interest rate derivatives protocol for Defi. It makes use of the EIP-5095 in order to separate an Interest Bearing Token into a principal token and a yield token. The yield token represents the yield generated by the IBT can sold, bought and traded.  
Its principal use-cases are: 
- Fixed Rate
- Variable Rates
- Upfront Yield
- Borrowing/Lending of Principal Tokens as collateral
- Yield Marketplace. 

## 2. Approach taken for this contest

### Time spent on this audit: 6 days

**Day 1:**
 - Reading the documentation
 - First pass through the code with a bottom to top approach
 - Adding @audit-info tags anytime a question came up
 - Studing EIP-4626 & EIP-5095

**Day 2:**
 - Drawing in Excalidraw:
   - Inheritance structure of the main contracts
   - User Flows 

**Day 3-4:**
 - Second pass through the code
 - Line-by-line review of every contract
 - Adding @audit-issue tags whenever I see something wrong
 - Trying to understand the 10k+ lines of tests

**Day 5-6:**
  - Third & Fourth pass of the code
  - Writing fuzz tests to search for issues
  - Writing up findings
  - Writing QA report
    
**Day 7:**
  - Writing Analysis report

## 3. Architecture

The protocol has provided an excellent drawing of the architecture, so there would no point in creating something similar. 

Since there are only 2 main contracts `PrincipalToken.sol` and `YieldToken.sol`, I have created diagrams of the inheritance/imports to better visualize the contract dependencies.  

`PrincipalToken.sol`
![PrincipalToken](https://github.com/Kraelog/images/blob/bdc78556b0846c7eaa0eb17ed92fa7e5b6ad718b/InheritancePT.png)

`YieldToken.sol`
![Architecture](https://github.com/Kraelog/images/blob/bdc78556b0846c7eaa0eb17ed92fa7e5b6ad718b/InheritanceYT.png)


## 4. User flows

For the major user paths, I have created detailed diagrams with the function calls in order to better build and visualize a mental model of the protocol. 

#### 1. Deposit 

  ![Deposit](https://github.com/Kraelog/images/blob/bdc78556b0846c7eaa0eb17ed92fa7e5b6ad718b/UserFlow_Deposit.png)

The protocol provides 4 external and 2 public functions in order to deposit into Spectra. 3 revolve around depositing IBT and 3 around depositing the underlying asset which will be converted into IBT. Then they converge to a single internal `_depositIBT` function which calls all the necessary functions to process the deposit.   

#### 2. Withdraw 

   ![Withdrawing](https://github.com/Kraelog/images/blob/bdc78556b0846c7eaa0eb17ed92fa7e5b6ad718b/UserFlow_Withdraw.png)
   
Again the protocol provides external and public functions, one for withdrawing assets and one for withdrawing IBT. Both functions call identical internals to handle the logic and the withdrawal process.  

#### 3. Redeem  

  ![Redeem](https://github.com/Kraelog/images/blob/bdc78556b0846c7eaa0eb17ed92fa7e5b6ad718b/UserFlow_Redeem.png)

The same pattern is followed, 2 external and 2 public functions with one sending IBT and one sending assets. Both call the internal function `_beforeRedeem`, which handles the majority of the logic.  

#### 4. Update Yield  

  ![Update Yield](https://github.com/Kraelog/images/blob/bdc78556b0846c7eaa0eb17ed92fa7e5b6ad718b/UserFlow_UpdateYield.png)
   
This function is used in almost all off the user paths and is a critical part of the protocol. Allowing the visibility to be public while having no access control gives rises to serious security vulnerabilities. Users can set ibt/pt rates without having deposited ibt or bought YT and can then profit from the difference when they do decide to participate. I have submitted a High and a Low severity finding concernig this. 

My recommandation is to set the visibilty to internal, this should not be accessible to users. 

#### 5. Transferring & Burning of Yield Tokens
  ![Transferring and burning of Yield Tokens](https://github.com/Kraelog/images/blob/bdc78556b0846c7eaa0eb17ed92fa7e5b6ad718b/UserFlow_YT.png)

The protocol allows for the transfer and burning of yield tokens. Concerning the burn function, this will break the stated invariant that PT supply should be equal to YT supply at all times.

#### 6. Flash Loan  
  ![Flash Loan](https://github.com/Kraelog/images/blob/bdc78556b0846c7eaa0eb17ed92fa7e5b6ad718b/UserFlow_FlashLoan.png)

The protocol also provide flash loan functionality. 

## 6. Code Quality / Test Quality

### Code

Overall, the quality of the code is absolutely excellent. The only remark that I have is that visibility of multiple functions could be changed to reduce the attack surface. 

### Testing

For a fairly small codebase, the amount of testing is mind-blowing. There are more than 10k lines of tests with very complex fuzz testing. 

The only remark I can give, is that I will use this test suite as inspiration for when I want to create my own fuzz tests. It is that good!

## 7. Risks

### Centralisation
 
#### 1. One-Step ownership change.

The address that is set as the "initialAuthority" has far reaching powers and there is no 2-step procedure to change the address. So this could a point of failure where if this address were to be compromised, the entire PT protocol could be in danger.  

## 8. Time spent

32 Hours


### Time spent:
32 hours